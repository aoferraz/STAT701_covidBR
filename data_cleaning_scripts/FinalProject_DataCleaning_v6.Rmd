---
title: "FinalProject_DataCleaning_v1"
author: "Alexandre"
date: "April/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(scipen = 0, digits = 3)
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(bestglm, glmnet, leaps, car, tidyverse, pROC, caret) # add the packages needed
library(xtable)
library(dplyr)
library(readxl)
```


```{r, echo=FALSE}
#clear variables
rm(list=ls())
```

# Geo data

## City names and codes

Source: IBGE, https://www.ibge.gov.br/explica/codigos-dos-municipios.php

```{r}
names <- read.csv("data/city_names_v1.csv", encoding = "UTF-8")
str(names) 

names <- names %>%
  rename(city_code = X.U.FEFF.city_code) %>%
  select(city_code, PT_city_UF)
str(names)   
```

## Codes and names variations

Variations of names, compiled from different data sources used, with corresponding IBGE code

```{r}
names_aux <- read.csv("data/COMPLETE_city_names_v1.csv", encoding = "UTF-8")
str(names_aux) 

names_aux <- names_aux %>%
   rename(PT_city_UF_aux = X.U.FEFF.PT_city_UF_aux) %>%
   select(city_code, PT_city_UF_aux)
str(names_aux)   
```

```{r}
names_aux2 <- read.csv("data/COMPLETE_city_names_v2.csv", encoding = "UTF-8")
str(names_aux2) 

names_aux2 <- names_aux2 %>%
  distinct() %>%
  rename(PT_city_UF_aux = X.U.FEFF.PT_city_UF_aux) %>%
  select(city_code, PT_city_UF_aux)
str(names_aux2)   
```

```{r}
names_aux3 <- read.csv("data/COMPLETE_city_names_v3.csv", encoding = "UTF-8")
str(names_aux3) 

names_aux3 <- names_aux3 %>%
  distinct() %>%
  rename(PT_city_UF_aux = X.U.FEFF.PT_city_UF_aux) %>%
  select(city_code, PT_city_UF_aux)
str(names_aux3)   
```

```{r}
names_aux4 <- read.csv("data/COMPLETE_city_names_v4.csv", encoding = "UTF-8")
str(names_aux4) 

names_aux4 <- names_aux4 %>%
  distinct() %>%
  rename(PT_city_UF_aux = X.U.FEFF.PT_city_UF_aux) %>%
  select(city_code, PT_city_UF_aux)
str(names_aux4)   
```
```{r}
names_aux5 <- read.csv("data/COMPLETE_city_names_v5.csv", encoding = "UTF-8")
str(names_aux5) 

names_aux5 <- names_aux5 %>%
  distinct() %>%
  rename(PT_city_UF_aux = X.U.FEFF.PT_city_UF_aux) %>%
  select(city_code, PT_city_UF_aux)
str(names_aux5)   
```

```{r}
names_aux6 <- read.csv("data/COMPLETE_city_names_v6.csv", encoding = "UTF-8")
str(names_aux6) 

names_aux6 <- names_aux6 %>%
  distinct() %>%
  rename(PT_city_UF_aux = X.U.FEFF.PT_city_UF_aux) %>%
  select(city_code, PT_city_UF_aux)
str(names_aux6)   
```

## Area

Source: IBGE, table 1301, https://sidra.ibge.gov.br/tabela/1301

```{r}
# Total city area
area <- read_xlsx("data/IBGE/tabela1301_area_densidade.xlsx", sheet = 1) #local path of database
#str(area)
a <- dim(area)

area <- area[-c(1,2,3,4,a[1]),]
 
area <- area %>%
  rename(city_UF = "Tabela 1301 - Área e Densidade demográfica da unidade territorial",
         city.area = ...2)
#str(area)

area[ area == "-" ] <- "0"
#str(area)

area <- bind_cols(area[,1], lapply(area[,2], as.numeric))
str(area)

# Match city codes
area <- area %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
area <- area[,c(3,2)]

# Save cleaned data
area %>%
  write.csv("data_cleaned/db_area.csv",row.names=FALSE)

```
## Urban area

Source: Geoinfo (2015), http://geoinfo.cnpm.embrapa.br/layers/geonode%3Aareas_urbanas_br_15

```{r}
# Urban area
area_urban <- read_xls("data/Geoinfo/areas_urbanas_br_2015.xls", sheet = 1) #local path of database
#str(area_urban)
a <- dim(area_urban)

area_urban <- area_urban %>%
  rename(city_code = Geocodigo, area.urban = Area_Urb)

area_urban <- area_urban[,c(6,5)]
str(area_urban)

#anti_join(names, area_urban, by = "city_code")

# Save cleaned data
area_urban %>%
  write.csv("data_cleaned/db_area_urban.csv",row.names=FALSE)
```

# Demographic data

## Absolute population (2011-20)

Source: Estimated population, IBGE, table 6576, https://sidra.ibge.gov.br/tabela/6579

```{r}
# Population
pop_aux <- read_xlsx("data/IBGE/tabela6579_pop_2011-20.xlsx", sheet = 1) #local path of database
#str(pop_aux)
a <- dim(pop_aux)

pop_aux <- pop_aux[-c(1,2,3,4,a[1]),]

pop_aux <- pop_aux %>%
  rename(city_UF = "Tabela 6579 - População residente estimada",
         pop.2011 = ...2,
         pop.2012 = ...3,
         pop.2013 = ...4,
         pop.2014 = ...5,
         pop.2015 = ...6,
         pop.2016 = ...7,
         pop.2017 = ...8,
         pop.2018 = ...9,
         pop.2019 = ...10,
         pop.2020 = ...11)
#str(pop_aux)

pop_aux[ pop_aux == "-" ] <- "0"
#str(pop_aux)

pop_aux <- bind_cols(pop_aux[,1], lapply(pop_aux[,c(2:11)], as.numeric))
str(pop_aux)

#sum(is.na(pop_aux))
```

```{r}
# Calculate annual population growth
pop <- pop_aux %>%
  mutate(pop.growth2011_20 = (pop.2020/pop.2011)^(1/9)-1)
str(pop)

# Match city codes
pop <- pop %>%
  inner_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop <- pop[,c(13,2:12)]

# Save cleaned data
pop %>%
  write.csv("data_cleaned/db_pop.csv",row.names=FALSE)
```

## Population by age bracket

Source: IBGE, table 2093, https://sidra.ibge.gov.br/tabela/2093#:~:text=Tabela%202093%3A%20Popula%C3%A7%C3%A3o%20residente%20por,Amostra%20%2D%20Caracter%C3%ADsticas%20Gerais%20da%20Popula%C3%A7%C3%A3o

```{r}
# Population by age
pop_age <- read_xlsx("data/IBGE/Censo_tabela2093_pop_idade.xlsx", sheet = 1) #local path of database
#str(pop_age)
a <- dim(pop_age)

pop_age <- pop_age[-c(1:6,a[1]),]
#str(pop_age)

pop_age <- pop_age %>%
  rename(city_UF = "Tabela 2093 - População residente por cor ou raça, sexo, situação do domicílio e grupos de idade - Amostra - Características Gerais da População",
         pop.0_4 = ...5,
         pop.5_9 = ...6,
         pop.10_14 = ...7,
         pop.15_19 = ...9,
         pop.20_24 = ...12,
         pop.25_29 = ...13,
         pop.30_39 = ...14,
         pop.40_49 = ...15,
         pop.50_59 = ...16,
         pop.60_69 = ...17,
         pop.70plus = ...19)
#str(pop_age)

pop_age <- pop_age[-1,c(1,5,6,7,9,12:17,19)]
#str(pop_age)

pop_age[ pop_age == "-" ] <- "0"
#str(pop_age)
 
pop_age <- bind_cols(pop_age[,1], lapply(pop_age[,c(2:12)], as.numeric))
#str(pop_age)

# Match city codes
pop_age <- pop_age %>%
  inner_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop_age <- pop_age[,c(13,2:12)]
str(pop_age)

# Save cleaned data
pop_age %>%
  write.csv("data_cleaned/db_pop_age.csv",row.names=FALSE)
```

## Population by sex

Source: IBGE, table 2093, https://sidra.ibge.gov.br/tabela/2093#:~:text=Tabela%202093%3A%20Popula%C3%A7%C3%A3o%20residente%20por,Amostra%20%2D%20Caracter%C3%ADsticas%20Gerais%20da%20Popula%C3%A7%C3%A3o

```{r}
# Population by sex
pop_sex <- read_xlsx("data/IBGE/Censo_tabela2093_pop_sexo.xlsx", sheet = 1) #local path of database
#str(pop_sex)
a <- dim(pop_sex)

pop_sex <- pop_sex[-c(1,2,3,4,5,6,7,a[1]),]

pop_sex <- pop_sex %>%
  rename(city_UF = "Tabela 2093 - População residente por cor ou raça, sexo, situação do domicílio e grupos de idade - Amostra - Características Gerais da População",
         pop.male = ...4,
         pop.female = ...5)
#str(pop_sex)

pop_sex <- pop_sex[,c(1,4,5)]
#str(pop_sex)

pop_sex[ pop_sex == "-" ] <- "0"
#str(pop_sex)

pop_sex <- bind_cols(pop_sex[,1], lapply(pop_sex[,c(2,3)], as.numeric))
#str(pop_sex)

# Match city codes
pop_sex <- pop_sex %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop_sex <- pop_sex[,c(4,2:3)]
str(pop_sex)

# Save cleaned data
pop_sex %>%
  write.csv("data_cleaned/db_pop_sex.csv",row.names=FALSE)
```

## Population rural vs urban

Source: IBGE, table 2093, https://sidra.ibge.gov.br/tabela/2093#:~:text=Tabela%202093%3A%20Popula%C3%A7%C3%A3o%20residente%20por,Amostra%20%2D%20Caracter%C3%ADsticas%20Gerais%20da%20Popula%C3%A7%C3%A3o

```{r}
# Population rural vs urban
pop_urban <- read_xlsx("data/IBGE/Censo_tabela2093_pop_ruralVSurbana.xlsx", sheet = 1) #local path of database
#str(pop_urban)
a <- dim(pop_urban)

pop_urban <- pop_urban[-c(1,2,3,4,5,6,7,8,a[1]),]

pop_urban <- pop_urban %>%
  rename(city_UF = "Tabela 2093 - População residente por cor ou raça, sexo, situação do domicílio e grupos de idade - Amostra - Características Gerais da População",
         pop.urban = ...3,
         pop.rural = ...4)
#str(pop_urban)
 
pop_urban <- pop_urban[,c(1,3,4)]
#str(pop_urban)

pop_urban[ pop_urban == "-" ] <- "0"
#str(pop_urban)

pop_urban <- bind_cols(pop_urban[,1], lapply(pop_urban[,c(2,3)], as.numeric))
#str(pop_urban)

# Match city codes
pop_urban <- pop_urban %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop_urban <- pop_urban[,c(4,2:3)]
str(pop_urban)

# Save cleaned data
pop_urban %>%
  write.csv("data_cleaned/db_pop_urban.csv",row.names=FALSE)
```

## Population by race

Source: IBGE, table 2093, https://sidra.ibge.gov.br/tabela/2093#:~:text=Tabela%202093%3A%20Popula%C3%A7%C3%A3o%20residente%20por,Amostra%20%2D%20Caracter%C3%ADsticas%20Gerais%20da%20Popula%C3%A7%C3%A3o

```{r}
# Population by race
pop_race <- read_xlsx("data/IBGE/Censo_tabela136_pop_raca.xlsx", sheet = 1) #local path of database
#str(pop_race)
a <- dim(pop_race)

pop_race <- pop_race[-c(1,2,3,a[1]),]

pop_race <- pop_race %>%
  rename(city_UF = "Tabela 136 - População residente, por cor ou raça",
         pop.white = ...17,
         pop.black = ...18,
         pop.asian = ...19,
         pop.pardos = ...20,
         pop.native = ...21,
         pop.others = ...22)
#str(pop_race)
  
pop_race <- pop_race[-c(1,2),c(1,17,18,19,20,21,22)]
#str(pop_race)

pop_race[ pop_race == "-" ] <- "0"
#str(pop_race)

pop_race <- bind_cols(pop_race[,1], lapply(pop_race[,c(2:7)], as.numeric))
#str(pop_race)

# Match city codes
pop_race <- pop_race %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop_race <- pop_race[,c(8,2:7)]
str(pop_race)

# Save cleaned data
pop_race %>%
  write.csv("data_cleaned/db_pop_race.csv",row.names=FALSE)
```

## Population by education

Source: IBGE, table 1972, https://sidra.ibge.gov.br/tabela/1972

```{r}
# Population by education level
pop_edu.lvl <- read_xlsx("data/IBGE/Censo_tabela1972_pop_educacaototal.xlsx", sheet = 1) #local path of database
#str(pop_edu.lvl)
a <- dim(pop_edu.lvl)

pop_edu.lvl <- pop_edu.lvl[-c(1,2,3,4,5,6,a[1]),]
 
pop_edu.lvl <- pop_edu.lvl %>%
  rename(city_UF = "Tabela 1972 - Pessoas que frequentavam creche ou escola por nível e rede de ensino",
         pop.edu.kindergarden = ...3, #PT: creche 
         pop.edu.pre = ...4, #PT: pré-escolar
         pop.edu.literacy = ...5, #PT: alfabetização
         pop.edu.literacy_adults = ...6, #PT: alfabetização de jovens e adultos
         pop.edu.elem = ...7, #PT: fundamental
         pop.edu.elem_adults = ...8, #PT: fundamental de jovens e adultos
         pop.edu.high = ...9, #PT: ensino médio
         pop.edu.high_adults = ...10, #PT: ensino médio de jovens e adultos
         pop.edu.undergrad = ...11, #PT: graduação
         pop.edu.grad = ...12, #PT: especialização
         pop.edu.master = ...13, #PT: mestrado
         pop.edu.doc = ...14) #PT: doutorado
#str(pop_edu.lvl)

pop_edu.lvl <- pop_edu.lvl[,-c(2)]
#str(pop_edu.lvl)
 
pop_edu.lvl[ pop_edu.lvl == "-" ] <- "0"
#str(pop_edu.lvl)
 
pop_edu.lvl <- bind_cols(pop_edu.lvl[,1], lapply(pop_edu.lvl[,c(2:13)], as.numeric))
str(pop_edu.lvl)
```

```{r}
# Population by education type (private vs public)
pop_edu.type <- read_xlsx("data/IBGE/Censo_tabela1972_pop_educacaoprivadaVSpublica.xlsx", sheet = 1) #local path of database
#str(pop_edu.type)
a <- dim(pop_edu.type)

pop_edu.type <- pop_edu.type[-c(1:6,a[1]),]
 
pop_edu.type <- pop_edu.type %>%
  rename(city_UF = "Tabela 1972 - Pessoas que frequentavam creche ou escola por nível e rede de ensino",
         pop.edu.public = ...3,
         pop.edu.private = ...4)
#str(pop_edu.type)
 
pop_edu.type <- pop_edu.type[,-c(2)]
#str(pop_edu.type)
  
pop_edu.type[ pop_edu.type == "-" ] <- "0"
#str(pop_edu.type)
  
pop_edu.type <- bind_cols(pop_edu.type[,1], lapply(pop_edu.type[,c(2:3)], as.numeric))
#str(pop_edu.type)

#Join education levels and type data sets
pop_edu <- left_join(pop_edu.lvl, pop_edu.type, by = "city_UF")
#str(pop_edu)

# Match city codes
pop_edu <- pop_edu %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop_edu <- pop_edu[,c(16,2:15)]
str(pop_edu)

# Save cleaned data
pop_edu %>%
  write.csv("data_cleaned/db_pop_edu.csv",row.names=FALSE)
```

## Residents per house

Source: IBGE, tabela 156, https://sidra.ibge.gov.br/tabela/156#:~:text=Tabela%20156%3A%20Domic%C3%ADlios%20particulares%20ocupados,moradores%20em%20domic%C3%ADlios%20particulares%20ocupados

```{r}
# Average residents per house
pop_residents <- read_xlsx("data/IBGE/Censo_tabela156_domicilios.xlsx", sheet = 3) #local path of database
#str(pop_residents)
a <- dim(pop_residents)

pop_residents <- pop_residents[-c(1:4,a[1]),]
  
pop_residents <- pop_residents %>%
  rename(city_UF = "Tabela 156 - Domicílios particulares ocupados, moradores em domicílios particulares ocupados e média de moradores em domicílios particulares ocupados",
         pop.residPerHouse = ...4)
#str(pop_residents)

pop_residents <- pop_residents[,-c(2,3)]
#str(pop_residents)
 
pop_residents[ pop_residents == "-" ] <- "0"
#str(pop_residents)
   
pop_residents <- bind_cols(pop_residents[,1], lapply(pop_residents[,c(2)], as.numeric))
#str(pop_residents)

# Match city codes
pop_residents <- pop_residents %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop_residents <- pop_residents[,c(3,2)]
str(pop_residents)
 
# Save cleaned data
pop_residents %>%
  write.csv("data_cleaned/db_pop_residents.csv",row.names=FALSE)

```

## Rooms per house

Source: IBGE, tabela 206, https://sidra.ibge.gov.br/tabela/206

```{r}
# Average rooms per house
pop_rooms <- read_xlsx("data/IBGE/Censo_tabela206_dom_comodos.xlsx", sheet = 1) #local path of database
#str(pop_rooms)
a <- dim(pop_rooms)

pop_rooms <- pop_rooms[-c(1:6,a[1]),]
  
pop_rooms <- pop_rooms %>%
  rename(city_UF = "Tabela 206 - Domicílios particulares permanentes por situação do domicílio e número de cômodos",
         pop.1rooms = ...15,
         pop.2rooms = ...16,
         pop.3rooms = ...17,
         pop.4rooms = ...18,
         pop.5rooms = ...19,
         pop.6rooms = ...20,
         pop.7rooms = ...21,
         pop.8rooms = ...22,
         pop.9rooms = ...23,
         pop.10plusrooms = ...24)
#str(pop_rooms)
 
pop_rooms <- pop_rooms[,c(1,15:24)]
#str(pop_rooms)
  
pop_rooms[ pop_rooms == "-" ] <- "0"
#str(pop_rooms)
    
pop_rooms <- bind_cols(pop_rooms[,1], lapply(pop_rooms[,c(2:11)], as.numeric))
#str(pop_rooms)

pop_rooms <- pop_rooms %>%
  mutate(pop.room.avg = 1/100*(1*pop.1rooms+
                        2*pop.2rooms+
                        3*pop.3rooms+
                        4*pop.4rooms+
                        5*pop.5rooms+
                        6*pop.6rooms+
                        7*pop.7rooms+
                        8*pop.8rooms+
                        9*pop.9rooms+
                        10*pop.10plusrooms)) #assuming 10+ rooms with 10 rooms
#str(pop_rooms)

sum(is.na(pop_rooms))

# Match city codes
pop_rooms <- pop_rooms %>%
  inner_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop_rooms <- pop_rooms[,c(13,2:12)]
str(pop_rooms)

# Save cleaned data
pop_rooms %>%
  write.csv("data_cleaned/db_pop_rooms.csv",row.names=FALSE)

```

## Population density

Source: IBGE, table 1301, https://sidra.ibge.gov.br/tabela/1301

```{r}
# Population density (2010)
pop.density_aux <- read_xlsx("data/IBGE/tabela1301_area_densidade.xlsx", sheet = 2) #local path of database
#str(pop.density_aux)
a <- dim(pop.density_aux)

pop.density_aux <- pop.density_aux[-c(1,2,3,4,a[1]),]
 
pop.density_aux <- pop.density_aux %>%
  rename(city_UF = "Tabela 1301 - Área e Densidade demográfica da unidade territorial",
         pop.density2010 = ...2)
#str(pop.density_aux)

pop.density_aux[ pop.density_aux == "-" ] <- "0"
#str(pop.density_aux)

pop.density_aux <- bind_cols(pop.density_aux[,1], lapply(pop.density_aux[,2], as.numeric))
#str(pop.density_aux)

# Match city codes
pop.density_aux <- pop.density_aux %>%
  inner_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop.density_aux <- pop.density_aux[,c(3,2)]
str(pop.density_aux)
```

````{r}
# Population density (tot pop 2015, urban area 2015, % urban 2010)
pop.density_aux2 <- pop.density_aux %>%
  left_join(pop[,c("city_code","pop.2015")], by = "city_code") %>%
    left_join(pop_urban, by = "city_code") %>%  
      inner_join(area_urban, by = "city_code")
#str(pop.density_aux2)
    
pop.density_aux2 <-data.frame(pop.density_aux2) %>%
  mutate(pop.urbanDensity = (pop.urban * pop.2015 /100) / area.urban)
 
pop.density_aux2 <- pop.density_aux2[,c(1,2,7)]
str(pop.density_aux2)

# Save cleaned data
pop.density_aux2 %>%
  write.csv("data_cleaned/db_pop_density.csv",row.names=FALSE)
```

## Access to tap  water

Source: IBGE, table 2065, https://sidra.ibge.gov.br/tabela/2065

```{r}
# Houses with access to tap (cleaned  and pipped) water
pop.water <- read_xlsx("data/IBGE/Censo_tabela2065_aguaEncanada.xlsx", sheet = 1) #local path of database
#str(pop.water)
a <- dim(pop.water)

pop.water <- pop.water[-c(1:5,a[1]),]
  
pop.water <- pop.water %>%
 rename(city_UF = "Tabela 2065 - Domicílios particulares permanentes, por existência de água canalizada e forma de abastecimento de água - Resultados Gerais da Amostra",
        pop.water.access = ...3,
        pop.water.accessInHouse = ...4,
        pop.water.accessInProperty = ...5,
        pop.water.noaccess = ...6)
#str(pop.water)
 
pop.water <- pop.water[,-c(2)]

pop.water[ pop.water == "-" ] <- "0"
#str(pop.water)

pop.water <- bind_cols(pop.water[,1], lapply(pop.water[,2:5], as.numeric))
#str(pop.water)
 
# Match city codes
pop.water <- pop.water %>%
  inner_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop.water <- pop.water[,c(6,2:5)]
str(pop.water)

# Save cleaned data
pop.water %>%
  write.csv("data_cleaned/db_pop_water.csv",row.names=FALSE)
```

## Bathrooms and sewage

Source: IBGE, table 3360, https://sidra.ibge.gov.br/tabela/3360

```{r}
# Houses with access to tap (cleaned  and pipped) water
pop.bathrooms <- read_xlsx("data/IBGE/Censo_tabela3360_banheiros.xlsx", sheet = 1) #local path of database
#str(pop.bathrooms)
a <- dim(pop.bathrooms)

pop.bathrooms <- pop.bathrooms[-c(1:6,a[1]),]
  
pop.bathrooms <- pop.bathrooms %>%
 rename(city_UF = "Tabela 3360 - Domicílios particulares permanentes e Moradores em domicílios particulares permanentes, em áreas urbanas com ordenamento regular, por existência de banheiro ou sanitário e tipo de esgotamento sanitário e existência e características do entorno",
        pop.bathroom.access = ...4,
        pop.bathroom.access.sewage = ...5,
        pop.bathroom.access.septicTank = ...6,
        pop.bathroom.access.other = ...7,
        pop.bathroom.noaccess = ...8)
#str(pop.bathrooms)
  
pop.bathrooms <- pop.bathrooms[,-c(2,3)]
#str(pop.bathrooms)

pop.bathrooms[ pop.bathrooms == "-" ] <- "0"
#str(pop.water)

pop.bathrooms <- bind_cols(pop.bathrooms[,1], lapply(pop.bathrooms[,2:6], as.numeric))
#str(pop.bathrooms)

# Match city codes
pop.bathrooms <- pop.bathrooms %>%
  inner_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
pop.bathrooms <- pop.bathrooms[,c(7,2:6)]
str(pop.bathrooms)
  
# Save cleaned data
pop.bathrooms %>%
  write.csv("data_cleaned/db_pop_bathrooms.csv",row.names=FALSE)
```

# Covid data

## Deaths and cases

Source: https://brasil.io/dataset/covid19/caso_full/


```{r}
covid <- read.csv("data/Brasil.io/caso_full.csv") #local path of database

covid$date <- as.Date(covid$date, "%Y-%m-%d")
str(covid) 
```

```{r find last day of complete data for all cities, warning=FALSE}

last <- covid %>% 
  filter(place_type == "city") %>%
    filter(is_last == "True" ) %>%
      group_by(city_ibge_code) %>%
      summarise(last_day_available = date) 

last_day <- min(last$last_day_available)
```

```{r calculate cumulate cases and deaths until last day of available date}

db_covid_last <- covid %>% 
 filter(place_type == "city") %>%
  filter(city_ibge_code != "") %>% 
    filter(date <= last_day) %>%
       group_by(city_ibge_code) %>%
       summarise(cases = sum(new_confirmed), deaths = sum(new_deaths)) %>%
       arrange(city_ibge_code)

sum(is.na(db_covid_last)) #check if there is any missing cities

# Save cleaned data
db_covid_last %>%
  write.csv("data_cleaned/db_covid_cases&deaths.csv",row.names=FALSE)
```

## Dedicated ICU beds sponsored by the Federal Government

Source: Localiza SUS, https://qsprod.saude.gov.br/extensions/DEMAS_C19Insumos_LEITOS_2021UTI/DEMAS_C19Insumos_LEITOS_2021UTI.html

```{r}
fed_covid_ICUbeds <- read.csv("data/Localiza_SUS/MS_Covid19_Leitos2021_19-04-21.csv", encoding = "UTF-8") #local path of database
#str(fed_covid_ICUbeds)

fed_covid_ICUbeds <- fed_covid_ICUbeds %>%
  select(Município, UF, Ano, Autorizações.publicadas, Valor.autorizações) %>%
  rename(PT_city = Município, Year = Ano, beds_authorized = Autorizações.publicadas, beds_authorized_cost = Valor.autorizações)
str(fed_covid_ICUbeds)
```

```{r}
aux_fed_covid_ICUbeds <- fed_covid_ICUbeds %>%
  filter(Year == 2021)%>%
    mutate(city_UF = paste0(PT_city," (",UF,")")) %>%
      group_by(city_UF)%>%
      summarise(beds = sum(beds_authorized), beds_cost = sum(beds_authorized_cost))

# anti_join(aux_fed_covid_ICUbeds, names_aux, by = c("city_UF" = "PT_city_UF_aux"))

db_fed_covid_ICUbeds <- full_join(aux_fed_covid_ICUbeds, names_aux, by = c("city_UF" = "PT_city_UF_aux")) %>%
  group_by(city_code)%>%
    summarise(beds = sum(beds), beds_cost = sum(beds_cost))

sum(is.na(db_fed_covid_ICUbeds$city_code)) #check if there is any missing or in excess cities

# Save cleaned data
db_fed_covid_ICUbeds %>%
  write.csv("data_cleaned/db_fed_covid_ICUbeds.csv",row.names=FALSE)

```

## Government expenditure with COVID

Source: Localiza SUS,  https://qsprod.saude.gov.br/extensions/DEMAS_C19SIOPS/DEMAS_C19SIOPS.html

```{r}
covid_spent <- read.csv("data/Localiza_SUS/MS_Covid19_Recursos_v2.csv", encoding = "UTF-8") #local path of database
#str(fed_covid_spent)

covid_spent <- covid_spent %>%
  mutate(city_UF = paste0(Município," (",UF,")")) %>%
  select(city_UF, Origem, Ano, Período, Valor.Empenhado..R...1, Valor.Pago..R...1) %>%
  rename(year = Ano, source = Origem, period = Período, 
         amount_committed = Valor.Empenhado..R...1, amount_disbursed = Valor.Pago..R...1)
str(covid_spent)
```
```{r}
aux_covid_spent <- covid_spent %>%
  filter(year == "2020") %>%
  group_by(city_UF, source, period) %>%
  summarise(amount_committed=sum(amount_committed), amount_disbursed=sum(amount_disbursed)) %>%
    pivot_wider(names_from = period, values_from = c(amount_committed, amount_disbursed)) %>%
      rename(exp_committed_p2 = "amount_committed_2º Bimestre",
             exp_committed_p3 = "amount_committed_3º Bimestre",
             exp_committed_p4 = "amount_committed_4º Bimestre",
             exp_committed_p5 = "amount_committed_5º Bimestre",
             exp_committed_p6 = "amount_committed_6º Bimestre",
             exp_disbursed_p2 = "amount_disbursed_2º Bimestre",
             exp_disbursed_p3 = "amount_disbursed_3º Bimestre",
             exp_disbursed_p4 = "amount_disbursed_4º Bimestre",
             exp_disbursed_p5 = "amount_disbursed_5º Bimestre",
             exp_disbursed_p6 = "amount_disbursed_6º Bimestre") %>%
      pivot_wider(names_from = source, 
                  values_from = c(exp_committed_p2, exp_committed_p3, exp_committed_p4, exp_committed_p5, exp_committed_p6,
                                  exp_disbursed_p2, exp_disbursed_p3, exp_disbursed_p4, exp_disbursed_p5, exp_disbursed_p6)) %>%
        rename(exp_committed_p2_city = "exp_committed_p2_Recurso Próprio",
               exp_committed_p3_city = "exp_committed_p3_Recurso Próprio",
               exp_committed_p4_city = "exp_committed_p4_Recurso Próprio",
               exp_committed_p5_city = "exp_committed_p5_Recurso Próprio",
               exp_committed_p6_city = "exp_committed_p6_Recurso Próprio",
               exp_disbursed_p2_city = "exp_disbursed_p2_Recurso Próprio",
               exp_disbursed_p3_city = "exp_disbursed_p3_Recurso Próprio",
               exp_disbursed_p4_city = "exp_disbursed_p4_Recurso Próprio",
               exp_disbursed_p5_city = "exp_disbursed_p5_Recurso Próprio",
               exp_disbursed_p6_city = "exp_disbursed_p6_Recurso Próprio",
               exp_committed_p2_state = "exp_committed_p2_Repasse Estadual",
               exp_committed_p3_state = "exp_committed_p3_Repasse Estadual",
               exp_committed_p4_state = "exp_committed_p4_Repasse Estadual",
               exp_committed_p5_state = "exp_committed_p5_Repasse Estadual",
               exp_committed_p6_state = "exp_committed_p6_Repasse Estadual",
               exp_disbursed_p2_state = "exp_disbursed_p2_Repasse Estadual",
               exp_disbursed_p3_state = "exp_disbursed_p3_Repasse Estadual",
               exp_disbursed_p4_state = "exp_disbursed_p4_Repasse Estadual",
               exp_disbursed_p5_state = "exp_disbursed_p5_Repasse Estadual",
               exp_disbursed_p6_state = "exp_disbursed_p6_Repasse Estadual",
               exp_committed_p2_fed = "exp_committed_p2_Repasse Federal",
               exp_committed_p3_fed = "exp_committed_p3_Repasse Federal",
               exp_committed_p4_fed = "exp_committed_p4_Repasse Federal",
               exp_committed_p5_fed = "exp_committed_p5_Repasse Federal",
               exp_committed_p6_fed = "exp_committed_p6_Repasse Federal",
               exp_disbursed_p2_fed = "exp_disbursed_p2_Repasse Federal",
               exp_disbursed_p3_fed = "exp_disbursed_p3_Repasse Federal",
               exp_disbursed_p4_fed = "exp_disbursed_p4_Repasse Federal",
               exp_disbursed_p5_fed = "exp_disbursed_p5_Repasse Federal",
               exp_disbursed_p6_fed = "exp_disbursed_p6_Repasse Federal")
# names(aux_covid_spent)

# match city with codes

aux2_covid_spent <- right_join(aux_covid_spent, names_aux2, by = c("city_UF" = "PT_city_UF_aux")) %>%
  group_by(city_code) %>%
   summarise(exp_committed_p2_city = sum(exp_committed_p2_city),
             exp_committed_p3_city = sum(exp_committed_p3_city),
             exp_committed_p4_city = sum(exp_committed_p4_city),
             exp_committed_p5_city = sum(exp_committed_p5_city),
             exp_committed_p6_city = sum(exp_committed_p6_city),
             exp_disbursed_p2_city = sum(exp_disbursed_p2_city),
             exp_disbursed_p3_city = sum(exp_disbursed_p3_city),
             exp_disbursed_p4_city = sum(exp_disbursed_p4_city),
             exp_disbursed_p5_city = sum(exp_disbursed_p5_city),
             exp_disbursed_p6_city = sum(exp_disbursed_p6_city),
             exp_committed_p2_state = sum(exp_committed_p2_state),
             exp_committed_p3_state = sum(exp_committed_p3_state),
             exp_committed_p4_state = sum(exp_committed_p4_state),
             exp_committed_p5_state = sum(exp_committed_p5_state),
             exp_committed_p6_state = sum(exp_committed_p6_state),
             exp_disbursed_p2_state = sum(exp_disbursed_p2_state),
             exp_disbursed_p3_state = sum(exp_disbursed_p3_state),
             exp_disbursed_p4_state = sum(exp_disbursed_p4_state),
             exp_disbursed_p5_state = sum(exp_disbursed_p5_state),
             exp_disbursed_p6_state = sum(exp_disbursed_p6_state),
             exp_committed_p2_fed = sum(exp_committed_p2_fed),
             exp_committed_p3_fed = sum(exp_committed_p3_fed),
             exp_committed_p4_fed = sum(exp_committed_p4_fed),
             exp_committed_p5_fed = sum(exp_committed_p5_fed),
             exp_committed_p6_fed = sum(exp_committed_p6_fed),
             exp_disbursed_p2_fed = sum(exp_disbursed_p2_fed),
             exp_disbursed_p3_fed = sum(exp_disbursed_p3_fed),
             exp_disbursed_p4_fed = sum(exp_disbursed_p4_fed),
             exp_disbursed_p5_fed = sum(exp_disbursed_p5_fed),
             exp_disbursed_p6_fed = sum(exp_disbursed_p6_fed))

sum(is.na(aux2_covid_spent$city_code)) #check if there is any missing cities

db_covid_spent <- aux2_covid_spent %>%
  filter(city_code != "")

# Save cleaned data
db_covid_spent %>%
  write.csv("data_cleaned/db_covid_spent.csv",row.names=FALSE)

```
          
## Vaccines

Source: Localiza SUS, https://qsprod.saude.gov.br/extensions/DEMAS_C19Vacina/DEMAS_C19Vacina.html


```{r}
vaccines <- read.csv("data/Localiza_SUS/Vacinas aplicadas_19-04-21.csv", encoding = "UTF-8") #local path of database
str(vaccines)

vaccines  <- vaccines %>%
  rename(city = X.U.FEFF..U.FEFF.Município) %>%
  mutate(city_UF = paste0(city," (",UF,")")) %>%
  select(city, UF, city_UF, Fabricante, Doses.Aplicadas, Dose.1, Dose.2) %>%
  rename(vac_provider = Fabricante, vac_shots = Doses.Aplicadas, vac_dose1 = Dose.1, vac_dose2 = Dose.2) %>%
  mutate(vac_provider = ifelse(vac_provider == "Vacina Adsorvida Covid-19 (Inativada) - Coronavac", "Coronavac", 
                                   ifelse(vac_provider == "Vacina Covid-19 - Covishield", "Covishield.AZ", "Unknown")))
str(vaccines)
```

```{r}
vaccines_aux <- vaccines %>%
  filter(UF != "-" & city != "-") %>%
    select(city_UF, vac_provider, vac_shots, vac_dose1, vac_dose2) %>%
        group_by(city_UF, vac_provider) %>%
        summarise(vac_shots = sum(vac_shots), vac_dose1 = sum(vac_dose1), vac_dose2 = sum(vac_dose2)) %>%
          pivot_wider(names_from = vac_provider, values_from = c(vac_shots, vac_dose1, vac_dose2)) %>%
            right_join(names, by = c("city_UF" = "PT_city_UF")) %>%
              group_by(city_code) %>%
                select(city_code, 
                    vac_shots_Coronavac, vac_shots_Covishield.AZ, vac_shots_Unknown,
                    vac_dose1_Coronavac, vac_dose1_Covishield.AZ, vac_dose1_Unknown, 
                    vac_dose2_Coronavac, vac_dose2_Covishield.AZ, vac_dose2_Unknown) %>%
                  arrange(city_code)

# Save cleaned data
vaccines_aux %>%
  write.csv("data_cleaned/db_vaccines.csv",row.names=FALSE)

```

## Federal covid emergency aid

Source: VIS DATA 3 beta, Auxílio Emergencial,  

https://aplicacoes.mds.gov.br/sagi/vis/data3/v.php?q[]=oNOtlcPavaarrLFrsWvJf7Od086vnG1ljah9aGl4ZnWraX9%2FZF2KjmObua5%2Bo7CjnbSardyedY6tYIyNY5NolszcuZmvq5piua%2BCgWNdgIyW2Z6fwu6wmWSIq26tcHl%2BYFi60JTWoqbA4HV0sntrbqVpdndYqpLHlNawmJjvv6mhg3Cg2qXAs3JoytagjbhUwOquoKG7mJ%2BhecN%2Fb1%2BDkVyVoKK%2B57Knn61deu9shYdjXYCMltmen8LusJlkiKtzr2V9d2KQxsKfz7CWwqONqm9%2BamapYnixpo7DxqbNolud8YBrbXRlY6ScvK%2BjksrEmJJ9qZCyhGBscWCd6Jq5s6qQvIlz4HBrkKd9XWerpJvlnsCxnFWX12aac1%2BNpHiXq6mhn%2BycsnZ3o4yVX5pmXsDqrqChu5ifoXnDf2hhg5FclaCivueyp5%2BtXXrvan2AY12AjJbZnp%2FC7rCZZIira6tveX5gWLrQlNaipsDgdXSyeWpupWl2eZqcuM2Y3aCYhbvDZnN4YWqiZLC9mJm81JbPZXPTrYVmaHheZdyorrqcoLrGW6qzZZaveWRlc5ip2qWywZqSf6GpnW5liat2X5%2B3lqberLCzX23NlGmWbVyI3ryVqK2ond5hjcRoYY%2BNY5NolszcuZmvq5piua9%2Bfm9Zh4pezayUyeDAl6FwdbCqa316Z1aCxKLLqZjQ3rJcfL5ncatlfXdikMbCn8%2BwlsKjjapugG1mqWJ4saaOw8amzaJbnfGAZGx0ZWOknLyvo5LKxJiSfamOr31gbHFgneiaubOqkLyJc%2BBuapanfV1nq6Sb5Z7AsZxVl9dkoXBfjaR4l6upoZ%2FsnLJ2d6OImGmWbVyI3ryVqK2ond5hjcRqY4eNY5NolszcuZmvq5piua%2BBgW9Zh4pezayUyeDAl6FwdbCtboJ6Z1aCxKLLqZjQ3rJcfL5pb7FlfXdikMbCn8%2BwlsKjjap1eWxmqWJ4saaOw8amzaJbnfGGZm50ZWOknLyvo5LKxJiSfamWs4BgbHFgneiaubOqkLyJc%2BB2a5OnfV1dxXCg2qXAs3KhydaYpXiZvufAmXeDqK%2FmXMOBbGi9wp%2Fdom7R7cKZd4Obm%2BWssolyoMzOVuVelszcuZmvq5piua%2BAf2lZh4pezayUyeDAl6FwdbCsb3l%2BYFi60JTWoqbA4HV0snlpcqVpdnmanLjNmN2gmIW7w21ydGVjpJy8r6OSysSYkn2pjquFYGxxYJ3omrmzqpC8iXPgbmWNp31dZ6ukm%2BWewLGcVZfXZaFvX42keJerqaGf7JyydnejiZlrlm1ciN68laitqJ3eYY3Eal2HjWOTXrCY4a6gr61wruuusolyk7jNps94btDwuleyfWh135q5wZxoy9Ooz3huw9y5p6GDcK3upnDJWJDGwp%2FPsJbCo42qb3hrZqlieLGmjsPGps2iW53xgmhoeF5l3KiuupygusZbqrNkjq95ZGVzmKnapbLBmpJ%2FoambbWWJq3Zfn7eWpt6ssLNfbc2SZaBpY4amsKOdtJqt3J51jq1ejJVfmmZewOquoKG7mJ%2BhecOAbl2DkVyVoKK%2B57Knn61deu9rhYBjXYCMltmen8LusJlkiKtssm15fmBO1JyZy6mmwrbBprGtcHXfmrnBnGiS1KjXYKmQsYFvoqmhrd50wcCskpKcmcuppsK2iKextVi1mpy8r6OSysSYkn2pkLOGYGxxYJ3omrmzqpC8iXPgcGmSp31dZ6ukm%2BWewLGcVZfXZqFuX42keJerqaGf7Jyydnejiphqlm1ciN68laitqJ3eYY3EamWKjWOTXrCY4a6gr61wruuusolyk7jNps94btDwuleyfGlxtJ%2BuuqqSktWl36JumOGuoK%2BtcHXsrrpxsk660JTWoqbA4HV0snlpaqVpdnmanLjNmN2gmIW7w2VzgWFqomSwvZiZvNSWz2Vz06yEZ2h4XmXcqK66nKC6xluqs2SUsXlkZXOYqdqlssGakn%2BhqZt1ZYmrdl%2Bft5am3qyws19tzZRpmmljhqawo520mq3cnnWOrWGKmV%2BaZl7A6q6gobuYn6F5w4JsYoORXJWgor7nsqefrV16722ChmNdgIyW2Z6fwu6wmWSIq3OqcHl%2BYFi60JTWoqbA4HV0soFnbKVpdnmanLjNmN2gmIW7w210e2FqomSwvZiZvNSWz2Vz07SFamh4Xlv2dLOvo6C8nKfcspiYtrOVqLuadbSswruzfbzUptmepn3guZmjC%2BKw3qLAbpicd6Ko4gDgyeS8VIG1mqzgnruxoI7DhInLqaLPm8GjsKmhWtpZwLOpTcnGo8uwpr7fvFSsraGpmXrCxvraw8qiioKgwu20maqrnpvlXJ2zqqDGwqaKop%2FC4hDhsq2erZmdvG6n8BHDn9Ogon2%2Brpidu6ms6FkQ6KWWutBTkrCYypuvo6i7lmOcj666pp931aLenp993G2nobpVrN6prsGqjrvQU9qepb6bvff2qqGj3KhtkZiRuNSn3KxTIBW7nZ%2B3VWLsnrpumZzD1JSTYIPC7sCjnbtVn%2BWetBHko7zKpoqhon3rEO6etJ6d6FmOvqOWusKn07Oifb6unbSpWJDapbzAV6HG1ZTWXZR97rKmXLqaqtqswK%2BbnHfRlNyeU80%2BB5aosZipmXq9uqCQuNWc4KxToNy2rJ1rhZ%2FsrLyvqk28zZjRAODT4LanXLikrJmmsremTaHWl9OgnL7ncIqdtKSsma28wpiZd8JT3aKlfe2ypJ27qJvdqG2%2BmJ%2B4gaMt95XJ5LCjXJKqnuKctq%2BjUKfGpt2slNCbsqChr%2Fjn7562wVeRxoGjLfeVyeSwo1yKpKbsmm2UmJoaDp%2FTnlaz3Lmjrmipqe2auW6YTcrGpYqvmM3cwKedrKRa6Zq%2Fr1edGhuV1qaWzJuPo6i7llq%2FmroR5JnAwq%2FaeA%3D%3D


```{r}
emergency_aid <- read.csv("data/VIS DATA 3/Auxilio Emergencial_2020-21.csv") #local path of database
str(emergency_aid)

emergency_aid <- emergency_aid %>%
  mutate(city_UF = paste0(Unidade.Territorial," (",UF,")")) %>%
  rename(year = Referência, 
         aid_people_CU = Pessoas.elegíveis.do.público.Cadastro.Único..sem.bolsa., 
         aid_value_CU = Valor.total.a.ser.repassado.para.público.Cadastro.Único..sem.bolsa., 
         aid_people_appCaixa = Pessoas.elegíveis.do.público.Aplicativo.Caixa, 
         aid_value_appCaixa = Valor.total.a.ser.repassado.para.público.Aplicativo.Caixa, 
         aid_people_lawsuit = Pessoas.elegíveis.por.meio.Judicial, 
         aid_value_lawsuit = Valor.total.a.ser.repassado.para.público.Judicial,
         aid_people_BolsaFamilia = Pessoas.elegíveis.do.público.Bolsa.Família,
         aid_value_BolsaFamilia = Valor.total.a.ser.repassado.para.público.Bolsa.Família,
         aid_people = Total.de.pessoas.Elegíveis) %>%
  mutate(aid_value = aid_value_CU + aid_value_appCaixa + aid_value_lawsuit + aid_value_BolsaFamilia) %>%
  select(-Código, -Unidade.Territorial, -UF)
  
```

```{r}
emergency_aid_aux <- emergency_aid %>%
  filter(year == 2020) %>%
  group_by(city_UF) %>%
    summarise(aid_people_CU = sum(aid_people_CU), 
              aid_people_appCaixa = sum(aid_people_appCaixa), 
              aid_people_lawsuit = sum(aid_people_lawsuit), 
              aid_people_BolsaFamilia = sum(aid_people_BolsaFamilia),
              aid_people = sum(aid_people),
              aid_value_CU = sum(aid_value_CU), 
              aid_value_appCaixa = sum(aid_value_appCaixa), 
              aid_value_lawsuit = sum(aid_value_lawsuit), 
              aid_value_BolsaFamilia = sum(aid_value_BolsaFamilia),
              aid_value = sum(aid_value))
str(emergency_aid_aux)

db_emergency_aid <- emergency_aid_aux %>%
  left_join(names_aux3, by = c("city_UF" = "PT_city_UF_aux")) %>%
  select(-city_UF) %>%
    arrange(city_code)
    
db_emergency_aid <- db_emergency_aid[, c(11, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)] 


# Save cleaned data
db_emergency_aid %>%
  write.csv("data_cleaned/db_emergency_aid.csv",row.names=FALSE)

```

# Economic data

## GDP by city (2010-18)

```{r}
# Total GDP
GDP.2010_14 <- read_xlsx("data/IBGE/tabela5938_PIB_2010-14.xlsx", sheet = 1) #local path of database
str(GDP.2010_14)
a <- dim(GDP.2010_14)

GDP.2010_14 <- GDP.2010_14[-c(1,2,3,a[1]),]
  
GDP.2010_14 <- GDP.2010_14 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.2010 = ...2,
         GDP.2011 = ...3,
         GDP.2012 = ...4,
         GDP.2013 = ...5,
         GDP.2014 = ...6)


GDP.2015_18 <- read_xlsx("data/IBGE/tabela5938_PIB_2015-18.xlsx", sheet = 1) #local path of database
str(GDP.2015_18)
a <- dim(GDP.2015_18)

GDP.2015_18 <- GDP.2015_18[-c(1,2,3,a[1]),]
  
GDP.2015_18 <- GDP.2015_18 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.2015 = ...2,
         GDP.2016 = ...3,
         GDP.2017 = ...4,
         GDP.2018 = ...5)
```

```{r}
# Tax GDP
GDP.tax.2010_14 <- read_xlsx("data/IBGE/tabela5938_PIB_2010-14.xlsx", sheet = 2) #local path of database
str(GDP.tax.2010_14)
a <- dim(GDP.tax.2010_14)

GDP.tax.2010_14 <- GDP.tax.2010_14[-c(1,2,3,a[1]),]
  
GDP.tax.2010_14 <- GDP.tax.2010_14 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.tax.2010 = ...2,
         GDP.tax.2011 = ...3,
         GDP.tax.2012 = ...4,
         GDP.tax.2013 = ...5,
         GDP.tax.2014 = ...6)


GDP.tax.2015_18 <- read_xlsx("data/IBGE/tabela5938_PIB_2015-18.xlsx", sheet = 2) #local path of database
str(GDP.tax.2015_18)
a <- dim(GDP.tax.2015_18)

GDP.tax.2015_18 <- GDP.tax.2015_18[-c(1,2,3,a[1]),]
  
GDP.tax.2015_18 <- GDP.tax.2015_18 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.tax.2015 = ...2,
         GDP.tax.2016 = ...3,
         GDP.tax.2017 = ...4,
         GDP.tax.2018 = ...5)
```  

```{r}
# Agriculture GDP
GDP.agri.2010_14 <- read_xlsx("data/IBGE/tabela5938_PIB_2010-14.xlsx", sheet = 4) #local path of database
str(GDP.agri.2010_14)
a <- dim(GDP.agri.2010_14)

GDP.agri.2010_14 <- GDP.agri.2010_14[-c(1,2,3,a[1]),]
  
GDP.agri.2010_14 <- GDP.agri.2010_14 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.agri.2010 = ...2,
         GDP.agri.2011 = ...3,
         GDP.agri.2012 = ...4,
         GDP.agri.2013 = ...5,
         GDP.agri.2014 = ...6)

GDP.agri.2015_18 <- read_xlsx("data/IBGE/tabela5938_PIB_2015-18.xlsx", sheet = 4) #local path of database
str(GDP.agri.2015_18)
a <- dim(GDP.agri.2015_18)

GDP.agri.2015_18 <- GDP.agri.2015_18[-c(1,2,3,a[1]),]
  
GDP.agri.2015_18 <- GDP.agri.2015_18 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.agri.2015 = ...2,
         GDP.agri.2016 = ...3,
         GDP.agri.2017 = ...4,
         GDP.agri.2018 = ...5)
```

```{r}
# Industry GDP
GDP.industry.2010_14 <- read_xlsx("data/IBGE/tabela5938_PIB_2010-14.xlsx", sheet = 5) #local path of database
str(GDP.industry.2010_14)
a <- dim(GDP.industry.2010_14)

GDP.industry.2010_14 <- GDP.industry.2010_14[-c(1,2,3,a[1]),]
  
GDP.industry.2010_14 <- GDP.industry.2010_14 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.industry.2010 = ...2,
         GDP.industry.2011 = ...3,
         GDP.industry.2012 = ...4,
         GDP.industry.2013 = ...5,
         GDP.industry.2014 = ...6)


GDP.industry.2015_18 <- read_xlsx("data/IBGE/tabela5938_PIB_2015-18.xlsx", sheet = 5) #local path of database
str(GDP.industry.2015_18)
a <- dim(GDP.industry.2015_18)

GDP.industry.2015_18 <- GDP.industry.2015_18[-c(1,2,3,a[1]),]
  
GDP.industry.2015_18 <- GDP.industry.2015_18 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.industry.2015 = ...2,
         GDP.industry.2016 = ...3,
         GDP.industry.2017 = ...4,
         GDP.industry.2018 = ...5)

```

```{r}
# Services GDP
GDP.services.2010_14 <- read_xlsx("data/IBGE/tabela5938_PIB_2010-14.xlsx", sheet = 6) #local path of database
str(GDP.services.2010_14)
a <- dim(GDP.services.2010_14)

GDP.services.2010_14 <- GDP.services.2010_14[-c(1,2,3,a[1]),]
  
GDP.services.2010_14 <- GDP.services.2010_14 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.services.2010 = ...2,
         GDP.services.2011 = ...3,
         GDP.services.2012 = ...4,
         GDP.services.2013 = ...5,
         GDP.services.2014 = ...6)


GDP.services.2015_18 <- read_xlsx("data/IBGE/tabela5938_PIB_2015-18.xlsx", sheet = 6) #local path of database
str(GDP.services.2015_18)
a <- dim(GDP.services.2015_18)

GDP.services.2015_18 <- GDP.services.2015_18[-c(1,2,3,a[1]),]
  
GDP.services.2015_18 <- GDP.services.2015_18 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.services.2015 = ...2,
         GDP.services.2016 = ...3,
         GDP.services.2017 = ...4,
         GDP.services.2018 = ...5)
```

```{r}
# Government GDP
GDP.govt.2010_14 <- read_xlsx("data/IBGE/tabela5938_PIB_2010-14.xlsx", sheet = 7) #local path of database
str(GDP.govt.2010_14)
a <- dim(GDP.govt.2010_14)

GDP.govt.2010_14 <- GDP.govt.2010_14[-c(1,2,3,a[1]),]
  
GDP.govt.2010_14 <- GDP.govt.2010_14 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.govt.2010 = ...2,
         GDP.govt.2011 = ...3,
         GDP.govt.2012 = ...4,
         GDP.govt.2013 = ...5,
         GDP.govt.2014 = ...6)


GDP.govt.2015_18 <- read_xlsx("data/IBGE/tabela5938_PIB_2015-18.xlsx", sheet = 7) #local path of database
str(GDP.govt.2015_18)
a <- dim(GDP.govt.2015_18)

GDP.govt.2015_18 <- GDP.govt.2015_18[-c(1,2,3,a[1]),]
  
GDP.govt.2015_18 <- GDP.govt.2015_18 %>%
  rename(city_UF = "Tabela 5938 - Produto interno bruto a preços correntes, impostos, líquidos de subsídios, sobre produtos a preços correntes e valor adicionado bruto a preços correntes total e por atividade econômica, e respectivas participações - Referência 2010",
         GDP.govt.2015 = ...2,
         GDP.govt.2016 = ...3,
         GDP.govt.2017 = ...4,
         GDP.govt.2018 = ...5)
```

```{r}
GDP_aux <- GDP.2015_18 %>%
  select(city_UF)

# Select GDP data with economy sector (2018)

GDP_aux <- bind_cols(GDP_aux, 
          as.numeric(unlist(GDP.agri.2015_18$GDP.agri.2018)), 
          as.numeric(unlist(GDP.govt.2015_18$GDP.govt.2018)), 
          as.numeric(unlist(GDP.industry.2015_18$GDP.industry.2018)), 
          as.numeric(unlist(GDP.services.2015_18$GDP.services.2018)), 
          as.numeric(unlist(GDP.tax.2015_18$GDP.tax.2018))) %>%
  rename(GDP.agri.2018 = ...2, 
         GDP.govt.2018 = ...3, 
         GDP.industry.2018 = ...4, 
         GDP.services.2018 = ...5, 
         GDP.tax.2018 = ...6)
#str(GDP_aux)

# Calculate GDP % per economy sector

GDP_aux <- GDP_aux %>%
    mutate(GDP.2018 = rowSums(.[2:6])) %>%
      mutate(GDP.agri.2018_pct = GDP.agri.2018 / GDP.2018,
             GDP.govt.2018_pct = GDP.govt.2018 / GDP.2018,
             GDP.industry.2018_pct = GDP.industry.2018 / GDP.2018,
             GDP.services.2018_pct = GDP.services.2018 / GDP.2018,
             GDP.tax.2018_pct = GDP.tax.2018 / GDP.2018)
     
GDP_aux <- GDP_aux[,c(1,8,9,10,11,12,7)]
str(GDP_aux)
```

```{r}
GDP_aux2 <- GDP.2015_18 %>%
  select(city_UF)

# Select GDP data to calculate growth (2010, 15, 18)
GDP_aux2 <-  GDP_aux2 %>%
  left_join(GDP.2010_14, by = "city_UF") %>%
    left_join(GDP.2015_18, by = "city_UF") %>%
      select(city_UF,GDP.2010, GDP.2015, GDP.2018)
#str(GDP_aux2)

GDP_aux2[ GDP_aux2 == "-" ] <- "0"
#str(GDP_aux2)
#sum(is.na(GDP_aux2))

GDP_aux2 <- bind_cols(GDP_aux2[,1], lapply(GDP_aux2[,2:4], as.numeric))
#str(GDP_aux2)
#sum(is.na(GDP_aux2))
#which(is.na(GDP_aux2), arr.ind = TRUE)

# Calculate annual nominal growth
GDP_aux2 <- data.frame(GDP_aux2) %>%
    mutate(GDP.growth2010_15 = (GDP.2015/GDP.2010)^(1/5)-1) %>%
    mutate(GDP.growth2015_18 = (GDP.2018/GDP.2015)^(1/3)-1)
#str(GDP_aux2)

GDP_aux2 <- GDP_aux2[,c(1,5,6)]
str(GDP_aux2)
#sum(is.na(GDP_aux2))
#which(is.na(GDP_aux2), arr.ind = TRUE) # cities non-existing in 2010 or 2015
```

```{r}
# Calculate GDP per capita in 2018
GDP_aux3 <- GDP_aux %>%
  select(city_UF, GDP.2018) %>%
    left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux")) %>%
      left_join(pop[,c("city_code","pop.2018")]) %>%
        mutate(GDP.percapita.2018 = GDP.2018 / pop.2018)
#str(GDP_aux3)

GDP_aux3 <- GDP_aux3[,c(1,3,5)]
str(GDP_aux3)
 
# Join all GDP tables 
GDP <- left_join(GDP_aux[,-7], GDP_aux2, by = "city_UF") %>%
  left_join(GDP_aux3, by = "city_UF")

GDP <- GDP[,c(9,2:8,10)]
str(GDP) 

sum(is.na(GDP))

# Save cleaned data
GDP %>%
  write.csv("data_cleaned/db_GDP.csv",row.names=FALSE)
```

## Work commuting time

Source: IBGE, table 3422, https://sidra.ibge.gov.br/tabela/3422

```{r}
# Work commuting time
commute_time <- read_xlsx("data/IBGE/Censo_tabela3422_tempoDeslocamento.xlsx", sheet = 1) #local path of database
#str(commute_time)
a <- dim(commute_time)

commute_time <- commute_time[-c(1:5,a[1]),-c(2)]

commute_time <- commute_time %>%
  rename(city_UF = "Tabela 3422 - Pessoas ocupadas na semana de referência, que trabalhavam fora do domicílio e retornavam para seu domicílio diariamente, por tempo habitual de deslocamento para o trabalho - Resultados Gerais da Amostra",
         time.5min = ...3,
         time.6_30min = ...4,
         time.30_60min = ...5,
         time.1_2h = ...6,
         time.2hplus = ...7)
#str(commute_time)
 
commute_time[ commute_time == "-" ] <- "0"
#str(commute_time)

commute_time <- bind_cols(commute_time[,1], lapply(commute_time[,c(2:6)], as.numeric))
#str(commute_time)

# Calculate average time
commute_time <- commute_time %>%
  mutate(time.avg = 1/100*(5*time.5min+ # assuming 5 min for avg
                           18*time.6_30min+  # assuming 18 min [=(6+30)/2] for avg
                           45*time.30_60min+  # assuming 4 min [=(30+60)/2] for avg
                           90*time.1_2h+  # assuming 90 min [=(60+120)/2] for avg
                           120*time.2hplus)) # assuming 120 min for avg
#str(commute_time)

# Match city codes
commute_time <- commute_time %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
commute_time <- commute_time[,c(8,2:7)]
str(commute_time)
 
# Save cleaned data
commute_time %>%
  write.csv("data_cleaned/db_commute_time.csv",row.names=FALSE)
```

## Average wage

Source: IBGE, table 3277, https://sidra.ibge.gov.br/tabela/3277

```{r}
# Wage level
wages2010 <- read_xlsx("data/IBGE/Censo_tabela3277_pop_rendimento.xlsx", sheet = 1) #local path of database
#str(wages2010)
a <- dim(wages2010)

wages2010 <- wages2010[-c(1:6,a[1]),-c(2:4,17)]
 
wages2010 <- wages2010 %>%
  rename(city_UF = "Tabela 3277 - Pessoas de 10 anos ou mais de idade, por classes de rendimento nominal mensal, segundo a situação do domicílio, o sexo e os grupos de idade",
         wages_less0.25 = ...5,
         wages_0.25to0.5 = ...6,
         wages_0.5to1 = ...7,
         wages_1to2 = ...8,
         wages_2to3 = ...9,
         wages_3to5 = ...10,
         wages_5to10 = ...11,
         wages_10to15 = ...12,
         wages_15to20 = ...13,
         wages_20to30 = ...14,
         wages_30plus = ...15,
         wages_noWage = ...16)
#str(wages2010)
  
wages2010[ wages2010 == "-" ] <- "0"
#str(wages)
 
wages2010 <- bind_cols(wages2010[,1], lapply(wages2010[,c(2:13)], as.numeric))
#str(wages2010)

# Calculate average wage
wages2010 <- wages2010 %>%
  mutate(wages_avg = 1/100*(0.25*wages_less0.25+ # assuming 0.25 minimum wages
                            0.375*wages_0.25to0.5+ # assuming 0.375 [=(0.25+0.5)/2] minimum wages
                            0.75*wages_0.5to1+ # assuming 0.75
                            1.5*wages_1to2+ # assuming 1.5
                            2.5*wages_2to3+ # assuming 2.5
                            4*wages_3to5+ # assuming 4
                            7.5*wages_5to10+ # assuming 7.5
                            12.5*wages_10to15+ # assuming 12.5
                            17.5*wages_15to20+ # assuming 17.5
                            25*wages_20to30+ # assuming 25
                            30*wages_30plus+ # assuming 30
                            0*wages_noWage)) # assuming 0
#str(wages2010)

# Match city codes
wages2010 <- wages2010 %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
wages2010 <- wages2010[,c(15,2:14)]
str(wages2010)
  
# Save cleaned data
wages2010 %>%
  write.csv("data_cleaned/db_wages2010.csv",row.names=FALSE)
```

## Employment type

Source: IBGE, table 1577, https://sidra.ibge.gov.br/tabela/1577

```{r}
# Employment type
employment2010 <- read_xlsx("data/IBGE/Censo_tabela1577_tipoEmprego.xlsx", sheet = 1) #local path of database
#str(employment2010)
a <- dim(employment2010)

employment2010 <- employment2010[-c(1:5,a[1]),-c(2)]
 
employment2010 <- employment2010 %>%
  rename(city_UF = "Tabela 1577 - Pessoas de 10 anos ou mais de idade por idade, ocupadas na semana de referência, por posição na ocupação e categoria do emprego no trabalho principal - Resultados Gerais da Amostra",
         employed = ...3,
         employed.privateFormal = ...4,
         employed.publicFormal = ...5,
         employed.informal = ...6,
         employed.noWage = ...7,
         employed.subsistence = ...8,
         employed.owner = ...9,
         employed.self = ...10)
#str(employment2010)

employment2010[ employment2010 == "-" ] <- "0"
#str(employment2010)
  
employment2010 <- bind_cols(employment2010[,1], lapply(employment2010[,c(2:9)], as.numeric))
#str(employment2010)
 
# Match city codes
employment2010 <- employment2010 %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
employment2010 <- employment2010[,c(10,2:9)]
str(employment2010)

# Save cleaned data
employment2010 %>%
  write.csv("data_cleaned/db_employment2010.csv",row.names=FALSE)
```

## Average working hours

Source: IBGE, table 1579, https://sidra.ibge.gov.br/tabela/1579

```{r}
# Number of working hours
working_hours <- read_xlsx("data/IBGE/Censo_tabela1579_horasTrabalho.xlsx", sheet = 1) #local path of database
#str(working_hours)
a <- dim(working_hours)

working_hours <- working_hours[-c(1:5,a[1]),-c(2)]
  
working_hours <- working_hours %>%
  rename(city_UF = "Tabela 1579 - Pessoas de 10 anos ou mais de idade, ocupadas na semana de referência, por grupos de horas habitualmente trabalhadas por semana no trabalho principal - Resultados Gerais da Amostra",
         workingHours_less14h = ...3,
         workingHours_15to39h = ...4,
         workingHours_40to44h = ...5,
         workingHours_45to48h = ...6,
         workingHours_49hplus = ...7)
#str(working_hours)
   
working_hours[ working_hours == "-" ] <- "0"
#str(working_hours)
  
working_hours <- bind_cols(working_hours[,1], lapply(working_hours[,c(2:6)], as.numeric))
#str(working_hours)
 
# Calculate average wage
working_hours <- working_hours %>%
  mutate(working_hours.avg = 1/100*(14*workingHours_less14h+ # assuming 14h
                                    27*workingHours_15to39h+ # assuming 27h [=(15+39)/2]
                                    42*workingHours_40to44h+ # assuming 42h
                                    46.5*workingHours_45to48h+ # assuming 46.5h
                                    49*workingHours_49hplus)) # assuming 49h
#str(working_hours)
 
# Match city codes
working_hours <- working_hours %>%
  left_join(names_aux4, by = c("city_UF" = "PT_city_UF_aux"))
working_hours <- working_hours[,c(8,2:7)]
#str(working_hours)
   
# Save cleaned data
working_hours %>%
  write.csv("data_cleaned/db_workingHours.csv",row.names=FALSE)
```

## Employed

Source: RAIS, https://bi.mte.gov.br/bgcaged/caged_rais_estabelecimento_id/login.php (login basico, password 12345678)

```{r}
# Evolution of number of employed (2002-19)
employed_evo <- read.csv("data/RAIS/VinculosAtivos_2002-19.csv") #local path of database
#str(employed_evo)
a <- dim(employed_evo)

employed_evo <- employed_evo[-c(5572:a[1]),c(1,2,3,6,11)]
#str(employed_evo)

employed_evo <- bind_cols(employed_evo[,1], lapply(employed_evo[,c(2:5)], as.numeric))
#str(employed_evo)
   
employed_evo <- employed_evo %>%
  mutate(employed.growth2010to15 = (X2015/X2010)^(1/5)-1,
         employed.growth2015to19 = (X2019/X2015)^(1/4)-1,
         employed.growth2018to19 = (X2019/X2018)-1)
#str(employed_evo)

employed_evo <- employed_evo %>%
  left_join(names_aux5, by = c("...1" = "PT_city_UF_aux"))

employed_evo <- employed_evo[,c(9,6:8,2)]
#str(employed_evo)

employed_evo <- employed_evo %>%
  left_join(pop, by = "city_code") %>%
    mutate(employed.pct2019 = X2019 / pop.2019)
#str(employed_evo)
    
employed_evo <- employed_evo[,c(1:4,17)]
str(employed_evo)

# Save cleaned data
employed_evo %>%
  write.csv("data_cleaned/db_employed_evo.csv",row.names=FALSE)
```

## Employed by economy sector

Source: RAIS, https://bi.mte.gov.br/bgcaged/caged_rais_estabelecimento_id/login.php (login basico, password 12345678)

```{r}
# Number of employed by economy sector (2019)
employed_type <- read.csv("data/RAIS/VinculosAtivos-byActivity_2019.csv") #local path of database
#str(employed_type)
a <- dim(employed_type)

employed_type <- employed_type[-c(5571:a[1]),]
#str(employed_type)
 
employed_type <- bind_cols(employed_type[,1], lapply(employed_type[,c(2:23)], as.numeric))
#str(employed_type)
    
employed_type <- employed_type %>%
  rename(city_UF = ...1, 
         employed.agri = Agricultura..Pecuária..Produção.Florestal..Pesca.e.AqÜIcultura,
         employed.indExtractive = Indústrias.Extrativas,
         employed.indTransform = Indústrias.de.Transformação,
         employed.power = Eletricidade.e.Gás,
         employed.waterSewage = Água..Esgoto..Atividades.de.Gestão.de.Resíduos.e.Descontaminação,
         employed.building = Construção,
         employed.trade = Comércio..Reparação.de.Veículos.Automotores.e.Motocicletas,
         employed.transport = Transporte..Armazenagem.e.Correio,
         employed.foodLodging = Alojamento.e.Alimentação,
         employed.communication = Informação.e.Comunicação,
         employed.finance = Atividades.Financeiras..de.Seguros.e.Serviços.Relacionados,
         employed.realState = Atividades.Imobiliárias,
         employed.professional = Atividades.Profissionais..Científicas.e.Técnicas,
         employed.admin = Atividades.Administrativas.e.Serviços.Complementares,
         employed.public = Administração.Pública..Defesa.e.Seguridade.Social,
         employed.education = Educação,
         employed.health = Saúde.Humana.e.Serviços.Sociais,
         employed.artsSports = Artes..Cultura..Esporte.e.Recreação,
         employed.otherServices= Outras.Atividades.de.Serviços,
         employed.home = Serviços.Domésticos,
         employed.international = Organismos.Internacionais.e.Outras.Instituições.Extraterritoriais,
         employed.total = Total)
#str(employed_type)
 
employed_type <- employed_type %>%
  left_join(names_aux5, by = c("city_UF" = "PT_city_UF_aux"))
 
employed_type <- employed_type[,c(24,2:23)]
#str(employed_type)
 
employed_type <- employed_type %>%
   mutate(employed.agri.pct = employed.agri / employed.total,
          employed.indExtractive.pct = employed.indExtractive / employed.total,
          employed.indTransform.pct = employed.indTransform / employed.total,
          employed.power.pct = employed.power / employed.total,
          employed.waterSewage.pct = employed.waterSewage / employed.total,
          employed.building.pct = employed.building / employed.total,
          employed.trade.pct = employed.trade / employed.total,
          employed.transport.pct = employed.transport / employed.total,
          employed.foodLodging.pct = employed.foodLodging / employed.total,
          employed.communication.pct = employed.communication / employed.total,
          employed.finance.pct = employed.finance / employed.total,
          employed.realState.pct = employed.realState / employed.total,
          employed.professional.pct = employed.professional / employed.total,
          employed.admin.pct = employed.admin / employed.total,
          employed.public.pct = employed.public / employed.total,
          employed.education.pct = employed.education / employed.total,
          employed.health.pct = employed.health / employed.total,
          employed.artsSports.pct = employed.artsSports / employed.total,
          employed.otherServices.pct = employed.otherServices / employed.total,
          employed.home.pct = employed.home / employed.total,
          employed.international.pct = employed.international / employed.total)
#str(employed_type)
     
employed_type <- employed_type[,c(1, 24:44)]
str(employed_type)
 
# Save cleaned data
employed_type %>%
  write.csv("data_cleaned/db_employed_type.csv",row.names=FALSE)
```

## Companies

Source: IBGE, Cadastro Central de Empresas, table 13, https://www.ibge.gov.br/estatisticas/economicas/comercio/2000-estatisticas-do-cadastro-central-de-empresas/9016-estatisticas-do-cadastro-central-de-empresas.html?=&t=resultados

```{r}
# Companies, salaries and workers (2018)
companies2018 <- read_xlsx("data/IBGE/Cadastro Central de Empresas_Tabela 13-2018.xlsx") #local path of database
#str(companies2018)
a <- dim(companies2018)

companies2018 <- companies2018[-c(1:32,5603:a[1]),c(2:10)]
#str(companies2018)
 
companies2018 <- companies2018 %>%
  rename(city_UF = ...2,
         companies.2018.qtde = ...3,
         workers.2018.total = ...4,
         workers.2018.hired = ...5,
         salary.2018 = ...8,
         companies.2018.qtdeActive = ...10)
#str(companies2018)

companies2018 <- companies2018[,-c(5,6,8)]
#str(companies2018)

companies2018 <- bind_cols(companies2018[,1], lapply(companies2018[,c(2:6)], as.numeric))
#str(companies2018)
    
companies2018 <- companies2018 %>%
  left_join(names_aux6, by = c("city_UF" = "PT_city_UF_aux"))
#str(companies2018)
 
companies2018 <- companies2018[,c(7,2:6)]
str(companies2018)
```

```{r}
# Companies, salaries and workers (2016)
companies2016 <- read_xlsx("data/IBGE/Cadastro Central de Empresas_Tabela 13-2016.xlsx") #local path of database
#str(companies2016)
a <- dim(companies2016)

companies2016 <- companies2016[-c(1:32,5603:a[1]),c(2:10)]
#str(companies2016)
 
companies2016 <- companies2016 %>%
  rename(city_UF = ...2,
         companies.2016.qtde = ...3,
         workers.2016.total = ...4,
         workers.2016.hired = ...5,
         salary.2016 = ...8,
         companies.2016.qtdeActive = ...10)
#str(companies2016)

companies2016 <- companies2016[,-c(5,6,8)]
#str(companies2016)

companies2016 <- bind_cols(companies2016[,1], lapply(companies2016[,c(2:6)], as.numeric))
#str(companies2016)
    
companies2016 <- companies2016 %>%
  left_join(names_aux6, by = c("city_UF" = "PT_city_UF_aux"))
#str(companies2016)
 
companies2016 <- companies2016[,c(7,2:6)]
str(companies2016)
 
```

```{r}
# Join companies data sets of 2018 and 2016
companies <- left_join(companies2018, companies2016, by = "city_code") %>%
  left_join(pop, by = "city_code")
#str(companies)

companies <- companies %>%
  mutate(companies.2018.per1Khab = companies.2018.qtdeActive/pop.2018 * 1000,
         workers.2018.pct = workers.2018.total/pop.2018,
         workers.growth.2016to18 = (workers.2018.total/workers.2016.total)^(1/2)-1,
         salary.growth.2016to18 = (salary.2018/salary.2016)^(1/2)-1,
         companies.growth.2016to18 = (companies.2018.qtdeActive/companies.2016.qtdeActive)^(1/2)-1)
#str(companies)

companies <- companies[,c(1,5,23:27)]
str(companies)

# Save cleaned data
companies %>%
  write.csv("data_cleaned/db_companies.csv",row.names=FALSE)
```

[end]
